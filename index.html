<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image Steganography — DWT+DCT Cloud Demo</title>

  <!-- Simple modern styling -->
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#6ee7b7; --accent2:#60a5fa;
      --glass: rgba(255,255,255,0.04);
      --max-width:1100px;
      --radius:12px;
      --gap:16px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%,#081326 60%);color:#e6eef8;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .page{max-width:var(--max-width);margin:28px auto;padding:22px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 40px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px;letter-spacing:0.2px}
    header p{margin:0;color:var(--muted);font-size:13px}

    .layout{display:grid;grid-template-columns:1fr 420px;gap:var(--gap);margin-top:18px}
    .main{background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 6px 20px rgba(2,6,23,0.45)}
    .side{background:var(--glass);padding:14px;border-radius:12px}

    .upload-row{display:flex;gap:12px;flex-wrap:wrap}
    .upload{flex:1;min-width:220px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

    .preview{width:100%;height:220px;object-fit:contain;background:linear-gradient(180deg,#071025,#0e1b2b);border-radius:8px;display:block;border:1px dashed rgba(255,255,255,0.04);padding:6px}
    .mini{height:120px}

    .controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:0;padding:9px 14px;border-radius:10px;color:#042228;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:9px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}

    .grid-view{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:6px 0 8px;font-size:13px;color:var(--muted)}
    .meta{font-size:13px;color:var(--muted);margin-top:8px}
    .status{font-size:13px;margin-top:8px;color:var(--muted)}

    .row-center{display:flex;gap:10px;align-items:center}
    .download-link{display:inline-block;padding:8px 10px;background:rgba(0,0,0,0.25);border-radius:8px;color:var(--accent);text-decoration:none;border:1px solid rgba(255,255,255,0.02);font-weight:600}

    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}.preview{height:180px}.mini{height:100px}}
  </style>
</head>
<body>
  <div class="page" role="main">
    <header>
      <div style="flex:1">
        <h1>Image Steganography — DWT + DCT (Cloud Demo)</h1>
        <p>Static frontend on GitHub Pages • Processing on Render (Flask). Use small images ≤512px for fastest results.</p>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px;color:#9fb6d1">Backend</div>
        <div style="font-weight:700;color:#cfeef6">https://stego-backend-l72r.onrender.com</div>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Upload + Preview + Actions -->
      <section class="main" aria-labelledby="uploader">
        <div id="uploader">
          <div class="upload-row">
            <div class="upload">
              <label class="small">Cover Image (Host)</label>
              <input id="cover-input" type="file" accept="image/*" />
              <img id="cover-preview" class="preview" alt="Cover preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
              <div class="meta">This image acts as the carrier. Recommended: photograph or complex texture.</div>
            </div>

            <div class="upload">
              <label class="small">Secret Image (to embed)</label>
              <input id="secret-input" type="file" accept="image/*" />
              <img id="secret-preview" class="preview" alt="Secret preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
              <div class="meta">This image will be hidden inside the cover.</div>
            </div>
          </div>

          <div class="controls">
            <button id="encode-btn" class="primary" disabled>Encode & Upload</button>
            <button id="clear-btn" class="ghost">Clear</button>
            <div id="encode-status" class="status" style="margin-left:8px"></div>
          </div>

          <div class="grid-view" style="margin-top:14px">
            <div class="card">
              <h4>Cover</h4>
              <img id="cover-mini" class="mini" alt="cover small" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
            </div>
            <div class="card">
              <h4>Secret</h4>
              <img id="secret-mini" class="mini" alt="secret small" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
            </div>
          </div>

          <div style="margin-top:12px;color:var(--muted);font-size:13px">
            Tip: the server resizes large images server-side to keep processing fast. If you want faster results, pick images ≤512px.
          </div>
        </div>
      </section>

      <!-- RIGHT: Results -->
      <aside class="side">
        <div class="card">
          <h4>Encoded (Stego)</h4>
          <img id="stego-preview" class="preview" alt="Stego preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
          <div class="row-center" style="margin-top:10px;justify-content:space-between">
            <div>
              <a id="stego-download" class="download-link" href="#" download="stego.png" style="display:none">Download Stego</a>
            </div>
            <div id="stego-meta" style="color:var(--muted);font-size:13px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Decoded (Extracted Secret)</h4>
          <img id="decoded-preview" class="preview" alt="Decoded preview" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" />
          <div class="row-center" style="margin-top:10px;justify-content:space-between">
            <div>
              <a id="decoded-download" class="download-link" href="#" download="extracted.png" style="display:none">Download Decoded</a>
            </div>
            <div id="decoded-meta" style="color:var(--muted);font-size:13px"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4>Decode Panel</h4>
          <label class="small">Upload Stego (or use encoded above)</label>
          <input id="stego-input" type="file" accept="image/*" />
          <label class="small" style="margin-top:8px">Original Cover (required)</label>
          <input id="orig-cover-input" type="file" accept="image/*" />
          <div class="controls" style="margin-top:8px">
            <button id="decode-btn" class="primary" disabled>Decode & Upload</button>
            <div id="decode-status" class="status"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>Project: Image Steganography (DWT + DCT). Backend: Flask on Render. Frontend: GitHub Pages.</div>
    </footer>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const BACKEND_URL = "https://stego-backend-l72r.onrender.com";
    const MAX_CLIENT_DIM = 800;   // optional client resizing cap for previews (not required)
    const UPLOAD_MAX_DIM = 512;   // server also resizes; keep uploads reasonable

    /* ---------- HELPERS ---------- */
    function el(id){ return document.getElementById(id); }
    function showStatus(id, txt, isError=false){ const e=el(id); e.textContent = txt; e.style.color = isError ? "crimson" : "var(--muted)"; }
    function enable(btn, yes=true){ btn.disabled = !yes; }

    // Read file to data URL
    function fileToDataURL(file){ return new Promise(res => {
      const r = new FileReader();
      r.onload = _ => res(r.result);
      r.readAsDataURL(file);
    });}

    // Resize image in browser (returns Blob PNG) - keeps memory low
    async function resizeImageFile(file, maxDim){
      if(!file) return null;
      const imgURL = await fileToDataURL(file);
      const img = new Image();
      await new Promise(r => { img.onload = r; img.src = imgURL; });
      const w = img.width, h = img.height;
      const max = Math.max(w,h);
      if(max <= maxDim) return file; // no need to resize
      const scale = maxDim / max;
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      return await new Promise(r => canvas.toBlob(blob => r(new File([blob], file.name, {type:'image/png'})), 'image/png', 0.9));
    }

    // Create downloadable blob URL and attach to link
    function attachDownload(linkEl, blob, filename){
      if(!blob){ linkEl.style.display='none'; return; }
      const url = URL.createObjectURL(blob);
      linkEl.href = url;
      linkEl.download = filename;
      linkEl.style.display = 'inline-block';
    }

    /* ---------- UI Wiring ---------- */
    const coverInput = el('cover-input'), secretInput = el('secret-input');
    const coverPreview = el('cover-preview'), secretPreview = el('secret-preview');
    const coverMini = el('cover-mini'), secretMini = el('secret-mini');
    const encodeBtn = el('encode-btn'), clearBtn = el('clear-btn'), encodeStatus = 'encode-status';
    const stegoPreview = el('stego-preview'), decodedPreview = el('decoded-preview');
    const stegoDownload = el('stego-download'), decodedDownload = el('decoded-download');
    const stegoMeta = el('stego-meta'), decodedMeta = el('decoded-meta');

    const stegoInput = el('stego-input'), origCoverInput = el('orig-cover-input');
    const decodeBtn = el('decode-btn');

    let lastStegoBlob = null, lastDecodedBlob = null;

    // Preview selected file in given img element
    async function showFilePreview(file, imgEl, miniEl=null){
      if(!file){ imgEl.src = blank(); if(miniEl) miniEl.src = blank(); return; }
      // resize for preview to MAX_CLIENT_DIM to avoid giant images on page
      const maybe = await resizeImageFile(file, MAX_CLIENT_DIM);
      const url = await fileToDataURL(maybe);
      imgEl.src = url;
      if(miniEl) miniEl.src = url;
    }

    function blank(){ return 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='; }

    // handle cover input
    coverInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      await showFilePreview(f, coverPreview, coverMini);
      enable(encodeBtn, coverInput.files.length && secretInput.files.length);
      showStatus(encodeStatus, '');
    });

    secretInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      await showFilePreview(f, secretPreview, secretMini);
      enable(encodeBtn, coverInput.files.length && secretInput.files.length);
      showStatus(encodeStatus, '');
    });

    clearBtn.addEventListener('click', () => {
      coverInput.value=''; secretInput.value=''; stegoInput.value=''; origCoverInput.value='';
      coverPreview.src = blank(); secretPreview.src = blank(); coverMini.src = blank(); secretMini.src = blank();
      stegoPreview.src = blank(); decodedPreview.src = blank();
      stegoDownload.style.display = decodedDownload.style.display = 'none';
      showStatus(encodeStatus, '');
      enable(encodeBtn, false);
      enable(decodeBtn, false);
    });

    // ENCODE action
    encodeBtn.addEventListener('click', async () => {
      if(!coverInput.files[0] || !secretInput.files[0]) { showStatus(encodeStatus, 'Select both images', true); return; }
      enable(encodeBtn, false);
      showStatus(encodeStatus, 'Preparing images...');
      try{
        const coverFile = await resizeImageFile(coverInput.files[0], UPLOAD_MAX_DIM);
        const secretFile = await resizeImageFile(secretInput.files[0], UPLOAD_MAX_DIM);
        showStatus(encodeStatus, 'Uploading and encoding on cloud (this may take 5–15s)...');
        const fd = new FormData();
        fd.append('cover', coverFile);
        fd.append('secret', secretFile);
        const resp = await fetch(BACKEND_URL + '/encode', { method:'POST', body: fd });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(txt || 'Server error');
        }
        const blob = await resp.blob();
        lastStegoBlob = blob;
        stegoPreview.src = URL.createObjectURL(blob);
        attachDownload(stegoDownload, blob, 'stego.png');
        stegoMeta.textContent = `Size: ${(blob.size/1024).toFixed(0)} KB`;
        showStatus(encodeStatus, 'Encoding successful.');
        // enable decode panel default: set stegoInput to blob via data URL (can't set file input programmatically)
        enable(decodeBtn, true);
      }catch(err){
        console.error(err);
        showStatus(encodeStatus, 'Error: ' + (err.message||err), true);
      } finally {
        enable(encodeBtn, true);
      }
    });

    // DECODE action (can take stego from file input or use lastStegoBlob)
    decodeBtn.addEventListener('click', async () => {
      // source stego: either from file input or lastStegoBlob in memory
      let stegoFile = null;
      if(stegoInput.files && stegoInput.files[0]) stegoFile = stegoInput.files[0];
      else if(lastStegoBlob) stegoFile = new File([lastStegoBlob], 'stego.png', {type:'image/png'});

      if(!stegoFile || !origCoverInput.files[0]) { showStatus('decode-status','Select stego and original cover.', true); return; }
      enable(decodeBtn, false);
      showStatus('decode-status','Uploading and extracting (server)...');
      try{
        const stegoUpload = await resizeImageFile(stegoFile, UPLOAD_MAX_DIM);
        const origCoverUpload = await resizeImageFile(origCoverInput.files[0], UPLOAD_MAX_DIM);
        const fd = new FormData();
        fd.append('stego', stegoUpload);
        fd.append('cover', origCoverUpload);
        const resp = await fetch(BACKEND_URL + '/decode', { method:'POST', body: fd });
        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(txt || 'Server error');
        }
        const blob = await resp.blob();
        lastDecodedBlob = blob;
        decodedPreview.src = URL.createObjectURL(blob);
        attachDownload(decodedDownload, blob, 'extracted.png');
        decodedMeta.textContent = `Size: ${(blob.size/1024).toFixed(0)} KB`;
        showStatus('decode-status','Extraction successful.');
      }catch(err){
        console.error(err);
        showStatus('decode-status','Error: ' + (err.message||err), true);
      } finally {
        enable(decodeBtn, true);
      }
    });

    // wire file change events for decode panel to show previews
    stegoInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      await showFilePreview(f, stegoPreview);
      enable(decodeBtn, f && origCoverInput.files.length);
    });
    origCoverInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      await showFilePreview(f, coverMini); // small preview in left column for reference
      enable(decodeBtn, f && (stegoInput.files.length || lastStegoBlob));
    });

    // initial state
    enable(encodeBtn, false);
    enable(decodeBtn, false);
  </script>
</body>
</html>
