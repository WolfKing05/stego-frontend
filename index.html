<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StegoVision — Pro Frontend</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0e1116; --card:#151821; --muted:#9aa4b2; --accent:#00b4d8; --accent-2:#48cae4; --glass:rgba(255,255,255,0.03);
    --success:#23d18b; --danger:#ff6b6b; --shadow:rgba(0,0,0,0.55);
  }
  /* Theme presets (will be toggled via JS by changing -- variables) */
  .theme-electric { --bg:#0b1220; --card:#0f1724; --accent:#00b4d8; --accent-2:#7be2f6; --muted:#cbd5e1; }
  .theme-crimson  { --bg:#0a0a0c; --card:#151215; --accent:#ff3b30; --accent-2:#ff6b6b; --muted:#e0cfd0; }
  .theme-forest   { --bg:#07120b; --card:#0f1b14; --accent:#3bcf6b; --accent-2:#6fe99b; --muted:#cfe6d0; }
  .theme-mono     { --bg:#fafafa; --card:#ffffff; --accent:#2b2b2b; --accent-2:#6b6b6b; --muted:#707070; --text:#111; }

  html,body{height:100%; margin:0; font-family:Inter,Segoe UI,system-ui; background:linear-gradient(180deg,var(--bg), #081018); color:var(--text, #e6eef6);}
  .wrap{max-width:1200px;margin:28px auto;padding:18px;}
  header{display:flex;align-items:center;gap:14px;padding:18px;border-radius:12px;background:var(--card);box-shadow:0 10px 30px var(--shadow);}
  header .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#001;letter-spacing:0.6px;}
  header h1{margin:0;font-size:1.2rem;color:var(--accent-2);font-weight:700}
  header .sub{margin-left:auto;color:var(--muted);font-size:0.9rem}

  .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px}
  .panel{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 20px var(--shadow)}
  .col{margin-bottom:12px}
  .label{font-size:0.85rem;color:var(--muted);margin-bottom:8px}
  .drop{border:1px dashed rgba(255,255,255,0.04); padding:12px;border-radius:8px;background:var(--glass);min-height:110px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;cursor:pointer}
  .drop img{max-height:160px;max-width:100%;object-fit:contain;border-radius:8px}
  input[type=file]{display:none}
  .row{display:flex;gap:10px}
  button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:#021;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(0,180,216,0.14)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
  .small{font-size:0.85rem;color:var(--muted)}
  .muted{color:var(--muted);font-size:0.9rem}
  .hint{font-size:0.85rem;color:var(--muted);margin-top:8px}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width 300ms ease}
  .history{max-height:260px;overflow:auto;margin-top:10px}
  .history .item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;font-size:0.9rem;display:flex;justify-content:space-between;align-items:center}
  .controls{display:flex;gap:8px;align-items:center}
  .theme-picker{display:flex;gap:8px;margin-left:12px}
  .theme-dot{width:18px;height:18px;border-radius:6px;cursor:pointer;border:1px solid rgba(0,0,0,0.2)}
  .meta{font-size:0.85rem;color:var(--muted);margin-top:10px}

  /* right column */
  .right .card-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .right .preview-block{display:flex;gap:10px;flex-direction:column}
  .preview-box{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;display:flex;flex-direction:column;align-items:center}
  .preview-img{width:100%;height:180px;object-fit:contain;border-radius:8px;background:transparent}
  .curl{font-family:monospace;font-size:0.86rem;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted);overflow:auto}

  .toast{position:fixed;right:18px;bottom:18px;background:#09121a;color:#bfefff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.5)}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body class="theme-electric">
<div class="wrap">
  <header>
    <div class="logo">SV</div>
    <h1>StegoVision — Pro</h1>
    <div class="sub">Cloud demo • Fast • Reliable</div>
  </header>

  <div class="grid">
    <!-- MAIN -->
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Encode / Decode</div>
          <h2 style="margin:6px 0 0;color:var(--accent-2)">Hide images in the cloud</h2>
        </div>
        <div class="controls">
          <div class="small muted">Theme</div>
          <div class="theme-picker" title="Pick theme">
            <div class="theme-dot" style="background:linear-gradient(90deg,#00b4d8,#48cae4)" data-theme="electric" onclick="setTheme('electric')"></div>
            <div class="theme-dot" style="background:linear-gradient(90deg,#ff3b30,#ff6b6b)" data-theme="crimson" onclick="setTheme('crimson')"></div>
            <div class="theme-dot" style="background:linear-gradient(90deg,#3bcf6b,#6fe99b)" data-theme="forest" onclick="setTheme('forest')"></div>
            <div class="theme-dot" style="background:linear-gradient(90deg,#2b2b2b,#6b6b6b)" data-theme="mono" onclick="setTheme('mono')"></div>
          </div>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0 18px">

      <!-- upload row -->
      <div class="row" style="margin-bottom:12px">
        <div style="flex:1">
          <div class="label">Cover (drop or click)</div>
          <label class="drop" id="dropCover">
            <div id="coverPlaceholder" class="muted">No cover selected — drag & drop or click to choose</div>
            <img id="coverImg" style="display:none" />
            <input id="coverFile" type="file" accept="image/*">
          </label>
          <div class="meta" id="coverMeta"></div>
        </div>

        <div style="width:14px"></div>

        <div style="width:320px">
          <div class="label">Secret (drop or click)</div>
          <label class="drop" id="dropSecret">
            <div id="secretPlaceholder" class="muted">No secret selected</div>
            <img id="secretImg" style="display:none" />
            <input id="secretFile" type="file" accept="image/*">
          </label>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <div class="small muted">Resize before upload</div>
            <select id="secretResize" style="background:transparent;border-radius:6px;padding:6px;border:1px solid rgba(255,255,255,0.04);color:var(--muted)">
              <option value="auto">Auto fit</option>
              <option value="128">128px</option>
              <option value="256">256px</option>
              <option value="512">512px</option>
            </select>
            <button class="ghost" id="sampleBtn">Sample</button>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button id="encodeBtn">Encode & Download</button>
        <button class="ghost" id="previewCurl">Show curl</button>
        <div style="flex:1"></div>
        <div class="small muted">Backend:</div>
        <div class="small" style="margin-left:6px;color:var(--accent-2)" id="backendUrl">https://stego-backend-l72r.onrender.com</div>
      </div>

      <div class="progress" style="margin-top:12px"><div class="bar" id="encodeBar"></div></div>
      <div id="encodeResult" class="hint"></div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:18px 0">

      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <div class="small muted">Recent actions</div>
          <div class="history" id="history"></div>
        </div>
        <div style="flex:1"></div>
        <div style="text-align:right">
          <div class="small muted">Quick decode</div>
          <input id="quickStego" type="file" accept="image/*" style="display:none">
          <button class="ghost" id="quickDecodeBtn">Choose stego</button>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="panel right">
      <div class="card-title">
        <div>
          <div class="small muted">Previews</div>
          <h3 style="margin:6px 0 0;color:var(--accent-2)">Cover • Stego • Extracted</h3>
        </div>
        <div>
          <button class="ghost" id="clearHistory">Clear</button>
        </div>
      </div>

      <div style="margin-top:12px" class="preview-block">
        <div class="preview-box">
          <div class="muted small">Cover preview</div>
          <img id="pCover" class="preview-img" src="">
        </div>

        <div class="preview-box">
          <div class="muted small">Stego preview (after encode)</div>
          <img id="pStego" class="preview-img" src="">
          <div style="display:flex;gap:8px;margin-top:8px">
            <a id="downloadStego" class="download" href="#" download="stego.png" style="display:none">⬇ Download stego</a>
            <a id="openStego" class="download" href="#" target="_blank" style="display:none">Open</a>
          </div>
        </div>

        <div class="preview-box">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted small">Extracted secret</div>
            <div>
              <label class="small muted" style="margin-right:8px">Contrast</label>
              <input id="contrast" type="range" min="0.6" max="1.8" step="0.05" value="1" />
            </div>
          </div>
          <img id="pExtract" class="preview-img" src="">
          <div style="display:flex;gap:8px;margin-top:8px">
            <a id="downloadExtract" class="download" href="#" download="extracted.png" style="display:none">⬇ Download extracted</a>
            <a id="openExtract" class="download" href="#" target="_blank" style="display:none">Open</a>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Built curl command (copy & run)</div>
          <pre class="curl" id="curlCmd">None yet</pre>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="ghost" id="copyCurl">Copy</button>
            <button class="ghost" id="replayLast">Replay last</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none">Ready</div>

<script>
  const BACKEND = document.getElementById('backendUrl').textContent.trim();
  let coverFile=null, secretFile=null, lastEncodedBlob=null, lastExtractedBlob=null;
  const historyKey='stego_history_v1';

  /* THEME */
  function setTheme(name){
    document.body.classList.remove('theme-electric','theme-crimson','theme-forest','theme-mono');
    if(name==='electric') document.body.classList.add('theme-electric');
    if(name==='crimson') document.body.classList.add('theme-crimson');
    if(name==='forest') document.body.classList.add('theme-forest');
    if(name==='mono') document.body.classList.add('theme-mono');
  }

  /* UTIL: show toast */
  function toast(msg, t=2000){
    const el=document.getElementById('toast');
    el.textContent=msg; el.style.display='block';
    clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',t);
  }

  /* DRAG & DROP */
  function bindDrop(dropEl, inputEl, imgEl, placeholderId, metaId){
    const input=document.getElementById(inputEl);
    const img=document.getElementById(imgEl);
    const placeholder=document.getElementById(placeholderId);
    const meta=document.getElementById(metaId||'');
    const drop=document.getElementById(dropEl);
    drop.addEventListener('click', ()=>input.click());
    input.addEventListener('change', ()=>handleFile(input.files[0], img, placeholder, meta));
    drop.addEventListener('dragover', e=>{e.preventDefault();drop.style.borderColor='rgba(255,255,255,0.12)';});
    drop.addEventListener('dragleave', e=>{drop.style.borderColor='transparent';});
    drop.addEventListener('drop', e=>{e.preventDefault();drop.style.borderColor='transparent';const f=e.dataTransfer.files[0]; input.files=f? [f] : []; handleFile(f,img,placeholder,meta);});
  }

  function handleFile(file,img,placeholder,meta){
    if(!file) return;
    const url=URL.createObjectURL(file);
    img.src=url; img.style.display='block'; if(placeholder) placeholder.style.display='none';
    const sizeKb=(file.size/1024).toFixed(0);
    if(meta) meta.textContent = `${file.name} · ${file.type || ''} · ${Math.round(file.size/1024)} KB`;
    if(img.id==='coverImg'){ coverFile=file; document.getElementById('pCover').src=url; }
    if(img.id==='secretImg'){ secretFile=file; }
  }

  bindDrop('dropCover','coverFile','coverImg','coverPlaceholder','coverMeta');
  bindDrop('dropSecret','secretFile','secretImg','secretPlaceholder');

  document.getElementById('sampleBtn').onclick = ()=>{
    // small demo images embedded as data URLs
    fetch('https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?w=600&q=60').then(r=>r.blob()).then(b=>{ const f=new File([b],'cover_sample.jpg',{type:b.type}); document.getElementById('coverFile').files = createFileList([f]); handleFile(f,document.getElementById('coverImg'),document.getElementById('coverPlaceholder'),document.getElementById('coverMeta'));});
    fetch('https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=300&q=60').then(r=>r.blob()).then(b=>{ const f=new File([b],'secret_sample.jpg',{type:b.type}); document.getElementById('secretFile').files = createFileList([f]); handleFile(f,document.getElementById('secretImg'),document.getElementById('secretPlaceholder'));});
  }

  // helper to set FileList when using JS (works in modern browsers)
  function createFileList(files){ const dataTransfer = new DataTransfer(); files.forEach(f=>dataTransfer.items.add(f)); return dataTransfer.files; }

  /* CLIENT-SIDE RESIZE SECRET */
  async function readImageAsCanvas(file, maxDim=null){
    return new Promise((res,rej)=>{
      const img=new Image();
      img.onload = ()=>{
        const canvas=document.createElement('canvas');
        let w=img.naturalWidth, h=img.naturalHeight;
        if(maxDim){ const scale = Math.min(1, maxDim / Math.max(w,h)); w=Math.round(w*scale); h=Math.round(h*scale); }
        canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        canvas.toBlob(b=>res({blob:b, w, h, url:canvas.toDataURL()}),'image/png');
      };
      img.onerror = ()=>rej('Image load failed');
      img.src = URL.createObjectURL(file);
    });
  }

  async function prepareSecretFile(){
    if(!secretFile) return null;
    const val=document.getElementById('secretResize').value;
    if(val==='auto'){ return secretFile; }
    const max = parseInt(val,10);
    try{
      const {blob,w,h,url} = await readImageAsCanvas(secretFile, max);
      // create File from blob
      const newFile = new File([blob], 'secret_resized.png', {type:'image/png'});
      // update preview to resized
      document.getElementById('secretImg').src = url;
      secretFile = newFile;
      return newFile;
    }catch(e){ toast('Secret resize failed'); return secretFile; }
  }

  /* ENCODE FLOW */
  async function encode(){
    if(!coverFile || !secretFile){ toast('Select cover and secret'); return; }
    document.getElementById('encodeBar').style.width='10%';
    document.getElementById('encodeResult').textContent='Preparing secret...';
    const readySecret = await prepareSecretFile();
    document.getElementById('encodeBar').style.width='25%';
    document.getElementById('encodeResult').textContent='Uploading to backend...';
    const fd = new FormData();
    fd.append('cover', coverFile);
    fd.append('secret', readySecret);
    try{
      const res = await fetch(BACKEND + '/encode', { method:'POST', body:fd });
      if(!res.ok){ const txt=await res.text(); throw new Error(txt); }
      const blob = await res.blob();
      lastEncodedBlob = blob;
      const url = URL.createObjectURL(blob);
      document.getElementById('pStego').src=url;
      document.getElementById('downloadStego').href=url; document.getElementById('downloadStego').style.display='inline-block';
      document.getElementById('openStego').href=url; document.getElementById('openStego').style.display='inline-block';
      document.getElementById('encodeBar').style.width='90%';
      document.getElementById('encodeResult').innerHTML = `<span style="color:var(--success)">Encoded — stego ready</span>`;
      addHistory({type:'encode', time:Date.now(), cover:coverFile.name, secret:readySecret.name});
      buildCurlCmd(coverFile.name, readySecret.name);
      setTimeout(()=>document.getElementById('encodeBar').style.width='0%',500);
      toast('Encode finished');
    }catch(err){
      document.getElementById('encodeResult').innerHTML = `<span style="color:var(--danger)">Error: ${err.message}</span>`;
      document.getElementById('encodeBar').style.width='0%';
      console.error(err);
      toast('Encode failed');
    }
  }

  document.getElementById('encodeBtn').onclick = encode;
  document.getElementById('previewCurl').onclick = ()=>{ const el=document.getElementById('curlCmd'); el.style.display = el.style.display==='block' ? 'none' : 'block'; };

  /* DECODE FLOW - using choose file quick decode or via right column button */
  document.getElementById('quickDecodeBtn').onclick = ()=> document.getElementById('quickStego').click();
  document.getElementById('quickStego').onchange = async function(){
    const f = this.files[0]; if(!f) return;
    await decodeFile(f);
  };

  async function decodeFile(file){
    document.getElementById('encodeBar').style.width='10%';
    document.getElementById('encodeResult').textContent='Uploading stego...';
    const fd = new FormData();
    fd.append('stego', file);
    try{
      const res = await fetch(BACKEND + '/decode', { method:'POST', body:fd });
      if(!res.ok){ const txt=await res.text(); throw new Error(txt); }
      const blob = await res.blob();
      lastExtractedBlob = blob;
      const url = URL.createObjectURL(blob);
      document.getElementById('pExtract').src = url;
      document.getElementById('downloadExtract').href = url; document.getElementById('downloadExtract').style.display='inline-block';
      document.getElementById('openExtract').href = url; document.getElementById('openExtract').style.display='inline-block';
      document.getElementById('encodeBar').style.width='100%';
      addHistory({type:'decode', time:Date.now(), stego:file.name});
      buildCurlCmdDecode(file.name);
      toast('Decode finished');
      setTimeout(()=>document.getElementById('encodeBar').style.width='0%',500);
    }catch(err){
      document.getElementById('encodeResult').innerHTML = `<span style="color:var(--danger)">Error: ${err.message}</span>`;
      document.getElementById('encodeBar').style.width='0%';
      toast('Decode failed');
    }
  }

  document.getElementById('decodeBtn').onclick = ()=> {
    const f = document.getElementById('stego').files[0];
    if(!f){ toast('Select a stego image'); return; }
    decodeFile(f);
  };

  /* CONTRAST slider for extracted preview */
  document.getElementById('contrast').oninput = function(){
    const v = parseFloat(this.value);
    const img = document.getElementById('pExtract');
    if(!img.src) return;
    img.style.filter = `contrast(${v})`;
  }

  /* HISTORY (localStorage) */
  function loadHistory(){
    try{
      const arr = JSON.parse(localStorage.getItem(historyKey) || '[]');
      const el = document.getElementById('history'); el.innerHTML='';
      arr.slice().reverse().forEach((h,i)=>{
        const div=document.createElement('div'); div.className='item';
        div.innerHTML = `<div>${h.type.toUpperCase()} • ${new Date(h.time).toLocaleTimeString()}</div>
          <div style="display:flex;gap:8px"><button class="ghost" onclick='replay(${i})'>Replay</button></div>`;
        el.appendChild(div);
      });
    }catch(e){}
  }
  function addHistory(obj){
    const arr = JSON.parse(localStorage.getItem(historyKey) || '[]');
    arr.push(obj);
    while(arr.length>30) arr.shift();
    localStorage.setItem(historyKey, JSON.stringify(arr));
    loadHistory();
  }
  function replay(indexFromEnd){
    const arr = JSON.parse(localStorage.getItem(historyKey) || '[]');
    const h = arr[arr.length-1-indexFromEnd];
    if(!h) return;
    if(h.type==='encode') toast('Replay not implemented for encode (use files).');
    if(h.type==='decode') toast('Replaying last decode is not supported in this demo.');
  }
  document.getElementById('clearHistory').onclick = ()=>{ localStorage.removeItem(historyKey); loadHistory(); toast('History cleared'); };

  /* CURL builder & copy */
  function buildCurlCmd(coverName, secretName){
    const cmd = `curl -F "cover=@${coverName}" -F "secret=@${secretName}" ${BACKEND}/encode --output stego.png`;
    document.getElementById('curlCmd').textContent = cmd;
  }
  function buildCurlCmdDecode(stegoName){
    const cmd = `curl -F "stego=@${stegoName}" ${BACKEND}/decode --output extracted.png`;
    document.getElementById('curlCmd').textContent = cmd;
  }
  document.getElementById('copyCurl').onclick = ()=>{ navigator.clipboard.writeText(document.getElementById('curlCmd').textContent); toast('Copied to clipboard'); };
  document.getElementById('replayLast').onclick = ()=>{ const txt=document.getElementById('curlCmd').textContent; navigator.clipboard.writeText(txt); toast('Curl copied'); };

  /* COPY curl preview */
  document.getElementById('previewCurl').addEventListener('click', ()=> {
    const el=document.getElementById('curlCmd'); el.style.display='block';
  });

  /* helper for file input preview from HTML input */
  document.getElementById('coverFile').addEventListener('change', e=>{ handleFile(e.target.files[0], document.getElementById('coverImg'), document.getElementById('coverPlaceholder'), document.getElementById('coverMeta')); });
  document.getElementById('secretFile').addEventListener('change', e=>{ handleFile(e.target.files[0], document.getElementById('secretImg'), document.getElementById('secretPlaceholder')); });
  document.getElementById('stego').addEventListener('change', e=>{ document.getElementById('stegoPreview').src = URL.createObjectURL(e.target.files[0]); });

  /* quick helpers to ensure theme persisted */
  (function init(){
    loadHistory();
    setTheme('electric'); // default; user can change
  })();

  // allow replay last encoded by downloading blob
  document.getElementById('downloadStego').addEventListener('click', e=>{ if(!lastEncodedBlob){ toast('No stego available'); e.preventDefault(); }});
  document.getElementById('downloadExtract').addEventListener('click', e=>{ if(!lastExtractedBlob){ toast('No extracted available'); e.preventDefault(); }});

</script>
</body>
</html>
